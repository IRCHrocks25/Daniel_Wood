{% extends 'base.html' %}

{% block title %}{{ course.name }} - Learning Platform{% endblock %}

{% block content %}
<div class="min-h-screen relative">

  <div class="max-w-7xl mx-auto px-6 py-12">
    <div class="grid lg:grid-cols-3 gap-8">

      <!-- MAIN -->
      <div class="lg:col-span-2 min-w-0">

        <!-- HERO -->
        <section class="rounded-[32px] border border-black/5 bg-white/70 backdrop-blur-xl shadow-[0_18px_70px_rgba(2,6,23,0.10)] overflow-hidden">
          <div class="relative">
            {% if course.thumbnail %}
              <img src="{{ course.thumbnail.url }}" alt="{{ course.name }}" class="h-56 w-full object-cover">
            {% else %}
              <div class="h-56 w-full bg-[linear-gradient(135deg,rgba(37,99,235,1),rgba(6,182,212,1))]"></div>
            {% endif %}
            <div class="absolute inset-0 bg-[linear-gradient(to_top,rgba(2,6,23,0.70),transparent_60%)]"></div>

            <div class="absolute top-5 left-5 right-5 flex items-start justify-between gap-4">
              <div class="flex flex-wrap items-center gap-2">
                <span class="inline-flex items-center gap-2 rounded-full bg-white/15 backdrop-blur px-3 py-1 text-xs font-semibold text-white border border-white/20">
                  <i class="fas fa-layer-group text-white/80"></i>
                  {{ course.get_course_type_display }}
                </span>

                {% if has_access %}
                  <span class="inline-flex items-center gap-2 rounded-full bg-emerald-500/90 px-3 py-1 text-xs font-semibold text-white border border-white/10">
                    <span class="h-1.5 w-1.5 rounded-full bg-white"></span> доступ granted
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-2 rounded-full bg-amber-500/90 px-3 py-1 text-xs font-semibold text-white border border-white/10">
                    <i class="fas fa-lock"></i> locked
                  </span>
                {% endif %}
              </div>

              {% if user.is_authenticated %}
              <button onclick="toggleFavorite({{ course.id }})"
                      class="inline-flex h-12 w-12 items-center justify-center rounded-2xl border border-white/20 bg-black/30 backdrop-blur shadow-sm hover:bg-black/40 transition"
                      title="Favorite">
                <i class="fas fa-heart text-xl {% if is_favorited %}text-rose-400{% else %}text-white/70 hover:text-rose-300{% endif %}"></i>
              </button>
              {% endif %}
            </div>

            <div class="absolute bottom-6 left-6 right-6">
              <h1 class="text-3xl md:text-4xl font-semibold tracking-tight text-white drop-shadow-sm">
                {{ course.name }}
              </h1>
              <p class="mt-2 text-sm md:text-base text-white/80 leading-7 max-w-2xl line-clamp-3">
                {{ course.description }}
              </p>
            </div>
          </div>

          <!-- CTA rail -->
          <div class="p-6 md:p-8 border-t border-black/5 bg-white/75">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div class="flex flex-wrap items-center gap-2">
                <span class="inline-flex items-center gap-2 rounded-full border border-black/5 bg-white px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm">
                  <i class="fas fa-play text-blue-600"></i>
                  {% if lessons %}{{ lessons|length }} lessons{% else %}Lessons soon{% endif %}
                </span>

                {% if user.is_authenticated %}
                <span class="inline-flex items-center gap-2 rounded-full border border-black/5 bg-white px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm">
                  <i class="fas fa-chart-line text-cyan-600"></i>
                  {{ course_progress }}% progress
                </span>
                {% endif %}
              </div>

              <div class="flex gap-3">
                {% if has_access %}
                  {% if lessons %}
                    {% for lesson in lessons %}
                      {% if forloop.first %}
                      <a href="{% url 'lesson_detail' course.slug lesson.slug %}"
                         class="inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-white px-6 py-3 text-sm font-semibold text-slate-900 shadow-sm hover:bg-slate-50 hover:border-slate-300 transition">
                        <i class="fas fa-play text-slate-700"></i>
                        {% if course_progress > 0 %}Continue{% else %}Start{% endif %}
                        <i class="fas fa-arrow-right text-slate-700"></i>
                      </a>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <span class="inline-flex items-center justify-center rounded-2xl bg-slate-100 px-6 py-3 text-sm font-semibold text-slate-600 border border-black/5">
                      Lessons coming soon
                    </span>
                  {% endif %}
                {% else %}
                  <span class="inline-flex items-center justify-center rounded-2xl bg-amber-50 px-6 py-3 text-sm font-semibold text-amber-800 border border-amber-200">
                    <i class="fas fa-lock mr-2"></i>{{ access_reason }}
                  </span>
                {% endif %}
              </div>
            </div>
          </div>
        </section>

        <!-- PREREQUISITES (premium alert) -->
        {% if not prerequisites_met and missing_prerequisites %}
        <section class="mt-6 rounded-[28px] border border-amber-200 bg-amber-50/80 backdrop-blur shadow-[0_10px_30px_rgba(2,6,23,0.06)] p-6">
          <div class="flex items-start gap-4">
            <div class="h-11 w-11 rounded-2xl bg-amber-500 text-white flex items-center justify-center shadow-sm">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="min-w-0">
              <h3 class="text-sm font-semibold text-amber-900">Prerequisites required</h3>
              <p class="mt-1 text-sm text-amber-800">Complete the following courses to unlock access:</p>
              <ul class="mt-3 space-y-1 text-sm text-amber-900">
                {% for prereq in missing_prerequisites %}
                <li class="flex items-center gap-2">
                  <span class="h-1.5 w-1.5 rounded-full bg-amber-700"></span>
                  <span class="truncate">{{ prereq.name }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </section>
        {% endif %}

        <!-- CONTENT -->
        {% if has_access %}
        <section class="mt-8">
          <div class="flex items-end justify-between mb-5">
            <div>
              <h2 class="text-2xl font-semibold text-slate-900">Course Content</h2>
              <p class="mt-1 text-sm text-slate-600">Work through lessons in order. Progress saves automatically.</p>
            </div>
          </div>

          <div class="rounded-[28px] border border-black/5 bg-white/75 backdrop-blur-xl shadow-[0_12px_40px_rgba(2,6,23,0.08)] overflow-hidden">
            {% if modules %}
              {% for module in modules %}
              <div class="border-b border-black/5 last:border-b-0">
                <div class="px-6 py-5 bg-white/60">
                  <div class="flex items-center justify-between gap-4">
                    <div>
                      <h3 class="text-lg font-semibold text-slate-900">{{ module.name }}</h3>
                      <p class="text-xs text-slate-500 mt-1">Module lessons below</p>
                    </div>
                    <span class="inline-flex items-center gap-2 rounded-full border border-black/5 bg-white px-3 py-1 text-xs font-semibold text-slate-700">
                      <i class="fas fa-folder-open text-blue-600"></i> Module
                    </span>
                  </div>
                </div>

                <div class="divide-y divide-black/5">
                  {% for item in lessons_with_status %}
                  {% if item.lesson.module == module %}
                  <div class="p-5 {% if not item.is_unlocked %}bg-slate-50/50 opacity-75{% else %}hover:bg-slate-50/70{% endif %} transition">
                    <div class="flex items-center justify-between gap-4">
                      <div class="flex items-start gap-4 min-w-0">
                        <div class="h-11 w-11 rounded-2xl {% if not item.is_unlocked %}bg-slate-100 border border-slate-200 text-slate-400{% else %}bg-blue-50 border border-black/5 text-blue-700{% endif %} flex items-center justify-center flex-shrink-0">
                          {% if not item.is_unlocked %}
                          <i class="fas fa-lock"></i>
                          {% else %}
                          <i class="fas fa-play"></i>
                          {% endif %}
                        </div>

                        <div class="min-w-0">
                          <div class="flex items-center gap-2">
                            <h4 class="font-semibold {% if not item.is_unlocked %}text-slate-500{% else %}text-slate-900{% endif %} truncate">{{ item.lesson.title }}</h4>

                            <!-- Status pill -->
                            {% if item.is_completed %}
                              <span class="inline-flex items-center gap-2 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-semibold text-emerald-700 border border-emerald-200">
                                <i class="fas fa-check-circle"></i> Completed
                              </span>
                            {% elif item.is_unlocked and item.lesson.id in user_progress %}
                              {% for progress_lesson_id, progress_obj in user_progress.items %}
                                {% if progress_lesson_id == item.lesson.id and progress_obj.status == 'in_progress' %}
                                  <span class="inline-flex items-center gap-2 rounded-full bg-cyan-50 px-2.5 py-1 text-xs font-semibold text-cyan-700 border border-cyan-200">
                                    <i class="fas fa-chart-line"></i> {{ progress_obj.progress_percentage }}%
                                  </span>
                                {% endif %}
                              {% endfor %}
                            {% elif not item.is_unlocked %}
                              <span class="inline-flex items-center gap-2 rounded-full bg-amber-50 px-2.5 py-1 text-xs font-semibold text-amber-700 border border-amber-200">
                                <i class="fas fa-lock"></i> Locked
                              </span>
                            {% endif %}
                          </div>

                          <div class="mt-1 flex flex-wrap items-center gap-3 text-xs {% if not item.is_unlocked %}text-slate-400{% else %}text-slate-500{% endif %}">
                            <span class="inline-flex items-center gap-1">
                              <i class="fas fa-clock"></i> {{ item.lesson.get_formatted_duration }}
                            </span>
                            <span class="inline-flex items-center gap-1">
                              <i class="fas fa-video"></i> Lesson
                            </span>
                          </div>
                        </div>
                      </div>

                      {% if item.is_unlocked %}
                      <a href="{% url 'lesson_detail' course.slug item.lesson.slug %}"
                         class="inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-white px-5 py-2.5 text-sm font-semibold text-slate-900 shadow-sm hover:bg-slate-50 hover:border-slate-300 transition flex-shrink-0">
                        {% if item.is_completed %}Review{% elif item.lesson.id in user_progress %}Continue{% else %}Start{% endif %}
                        <i class="fas fa-arrow-right text-slate-700"></i>
                      </a>
                      {% else %}
                      <div class="inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-5 py-2.5 text-sm font-semibold text-slate-400 cursor-not-allowed flex-shrink-0">
                        <i class="fas fa-lock"></i>
                        Locked
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endif %}
                  {% endfor %}
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div class="divide-y divide-black/5">
                {% for item in lessons_with_status %}
                <div class="p-5 {% if not item.is_unlocked %}bg-slate-50/50 opacity-75{% else %}hover:bg-slate-50/70{% endif %} transition">
                  <div class="flex items-center justify-between gap-4">
                    <div class="flex items-start gap-4 min-w-0">
                      <div class="h-11 w-11 rounded-2xl {% if not item.is_unlocked %}bg-slate-100 border border-slate-200 text-slate-400{% else %}bg-blue-50 border border-black/5 text-blue-700{% endif %} flex items-center justify-center flex-shrink-0">
                        {% if not item.is_unlocked %}
                        <i class="fas fa-lock"></i>
                        {% else %}
                        <i class="fas fa-play"></i>
                        {% endif %}
                      </div>

                      <div class="min-w-0">
                        <div class="flex items-center gap-2">
                          <h4 class="font-semibold {% if not item.is_unlocked %}text-slate-500{% else %}text-slate-900{% endif %} truncate">{{ item.lesson.title }}</h4>

                          {% if item.is_completed %}
                            <span class="inline-flex items-center gap-2 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-semibold text-emerald-700 border border-emerald-200">
                              <i class="fas fa-check-circle"></i> Completed
                            </span>
                          {% elif item.is_unlocked and item.progress_obj and item.progress_obj.status == 'in_progress' %}
                            <span class="inline-flex items-center gap-2 rounded-full bg-cyan-50 px-2.5 py-1 text-xs font-semibold text-cyan-700 border border-cyan-200">
                              <i class="fas fa-chart-line"></i> {{ item.progress_obj.progress_percentage }}%
                            </span>
                          {% elif not item.is_unlocked %}
                            <span class="inline-flex items-center gap-2 rounded-full bg-amber-50 px-2.5 py-1 text-xs font-semibold text-amber-700 border border-amber-200">
                              <i class="fas fa-lock"></i> Locked
                            </span>
                          {% endif %}
                        </div>

                        <div class="mt-1 flex flex-wrap items-center gap-3 text-xs {% if not item.is_unlocked %}text-slate-400{% else %}text-slate-500{% endif %}">
                          <span class="inline-flex items-center gap-1">
                            <i class="fas fa-clock"></i> {{ item.lesson.get_formatted_duration }}
                          </span>
                          <span class="inline-flex items-center gap-1">
                            <i class="fas fa-video"></i> Lesson
                          </span>
                        </div>
                      </div>
                    </div>

                    {% if item.is_unlocked %}
                    <a href="{% url 'lesson_detail' course.slug item.lesson.slug %}"
                       class="inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-white px-5 py-2.5 text-sm font-semibold text-slate-900 shadow-sm hover:bg-slate-50 hover:border-slate-300 transition flex-shrink-0">
                      {% if item.is_completed %}Review{% elif item.lesson.id in user_progress %}Continue{% else %}Start{% endif %}
                      <i class="fas fa-arrow-right text-slate-700"></i>
                    </a>
                    {% else %}
                    <div class="inline-flex items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-5 py-2.5 text-sm font-semibold text-slate-400 cursor-not-allowed flex-shrink-0">
                      <i class="fas fa-lock"></i>
                      Locked
                    </div>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </section>
        {% endif %}
      </div>

      <!-- RIGHT RAIL (sticky) -->
      <aside class="lg:col-span-1">
        <div class="sticky top-6 space-y-6">

          <!-- Progress -->
          {% if user.is_authenticated %}
          <div class="rounded-[28px] border border-black/5 bg-white/75 backdrop-blur-xl shadow-[0_12px_40px_rgba(2,6,23,0.08)] p-6">
            <h3 class="text-lg font-semibold text-slate-900">Your Progress</h3>
            <p class="mt-1 text-sm text-slate-600">Consistency beats intensity.</p>

            <div class="mt-5">
              <div class="flex items-center justify-between">
                <div class="text-xs font-semibold text-slate-500">Course completion</div>
                <div class="inline-flex items-center gap-2 rounded-full border border-black/5 bg-white px-2.5 py-1 text-xs font-semibold text-slate-700">
                  <i class="fas fa-chart-line text-blue-600"></i> {{ course_progress }}%
                </div>
              </div>
              <div class="mt-2 h-2.5 rounded-full bg-slate-100 overflow-hidden border border-black/5">
                <div class="h-2.5 rounded-full bg-[linear-gradient(90deg,rgba(37,99,235,1),rgba(6,182,212,1))]"
                     style="width: {{ course_progress }}%"></div>
              </div>
            </div>

            <div class="mt-5">
              {% if has_access and lessons %}
                {% for lesson in lessons %}
                  {% if forloop.first %}
                  <a href="{% url 'lesson_detail' course.slug lesson.slug %}"
                     class="inline-flex w-full items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-white px-5 py-3 text-slate-900 text-sm font-semibold shadow-sm hover:bg-slate-50 hover:border-slate-300 transition">
                    <i class="fas fa-play text-slate-700"></i>
                    {% if course_progress > 0 %}Continue{% else %}Start{% endif %}
                    <i class="fas fa-arrow-right text-slate-700"></i>
                  </a>
                  {% endif %}
                {% endfor %}
              {% else %}
                <div class="mt-1 rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm font-semibold text-amber-800">
                  <i class="fas fa-lock mr-2"></i>{{ access_reason }}
                </div>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Access / Requirements -->
          {% if not prerequisites_met and missing_prerequisites %}
          <div class="rounded-[28px] border border-amber-200 bg-amber-50/80 backdrop-blur shadow-[0_10px_30px_rgba(2,6,23,0.06)] p-6">
            <h3 class="text-lg font-semibold text-amber-900">Unlock requirements</h3>
            <p class="mt-1 text-sm text-amber-800">Finish prerequisites to access lessons.</p>
          </div>
          {% endif %}

          <!-- Tips / micro-help (makes product feel “real”) -->
          <div class="rounded-[28px] border border-black/5 bg-white/75 backdrop-blur-xl shadow-[0_12px_40px_rgba(2,6,23,0.08)] p-6">
            <h3 class="text-lg font-semibold text-slate-900">How to win this course</h3>
            <ul class="mt-3 space-y-2 text-sm text-slate-600">
              <li class="flex gap-2"><i class="fas fa-check text-emerald-600 mt-0.5"></i> Watch one lesson start-to-finish.</li>
              <li class="flex gap-2"><i class="fas fa-check text-emerald-600 mt-0.5"></i> Take notes on 3 key takeaways.</li>
              <li class="flex gap-2"><i class="fas fa-check text-emerald-600 mt-0.5"></i> Apply one idea within 24 hours.</li>
            </ul>
          </div>

        </div>
      </aside>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function toggleFavorite(courseId) {
  try {
    const response = await fetch(`/api/courses/${courseId}/favorite/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCsrfToken() },
    });
    const data = await response.json();
    if (data.success) location.reload();
  } catch (error) {
    console.error('Error toggling favorite:', error);
  }
}
</script>
{% endblock %}
