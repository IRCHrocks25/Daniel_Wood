{% extends 'base.html' %}
{% load editorjs %}

{% block title %}{{ lesson.title }} - {{ course.name }}{% endblock %}

{% block content %}
<div class="min-h-screen relative">

  <div class="max-w-7xl mx-auto px-6 py-10">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-slate-600">
      <a href="{% url 'student_dashboard' %}" class="hover:text-slate-900 font-semibold">Dashboard</a>
      <i class="fas fa-chevron-right mx-2 text-slate-400"></i>
      <a href="{% url 'course_detail' course.slug %}" class="hover:text-slate-900 font-semibold">{{ course.name }}</a>
      <i class="fas fa-chevron-right mx-2 text-slate-400"></i>
      <span class="text-slate-900 font-semibold">{{ lesson.title }}</span>
    </nav>

    <!-- 30% / 70% layout -->
    <div class="grid grid-cols-1 lg:grid-cols-10 gap-8">

      <!-- LEFT: Lessons Navigation (30%) -->
      <aside class="lg:col-span-3">
        <div class="sticky top-6">
          <!-- Wrapper to keep spacing consistent -->
          <div class="space-y-6">

            <!-- Lessons list -->
            <div class="rounded-[28px] border border-black/5 bg-white/70 backdrop-blur-xl shadow-[0_12px_40px_rgba(2,6,23,0.08)] overflow-hidden">
              <div class="px-6 py-5 border-b border-black/5">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-slate-900">Lessons</h3>
                  <span class="text-xs font-semibold text-slate-500">{{ all_lessons_with_progress|length }}</span>
                </div>
                <p class="mt-1 text-sm text-slate-600">Navigate the course in order.</p>
              </div>

              <!-- Scroll region -->
              <div class="max-h-[calc(100vh-260px)] overflow-y-auto px-4 py-4 space-y-2">
                {% for item in all_lessons_with_progress %}
                  {% if item.is_current %}
                    <div class="group rounded-2xl border border-blue-200 bg-[linear-gradient(135deg,rgba(37,99,235,0.10),rgba(6,182,212,0.06))] px-4 py-3 shadow-sm">
                      <div class="flex items-start gap-3">
                        <div class="mt-0.5 flex-shrink-0">
                          <div class="h-8 w-8 rounded-2xl bg-blue-600 flex items-center justify-center shadow-sm">
                            <span class="text-xs font-bold text-white">{{ forloop.counter }}</span>
                          </div>
                        </div>

                        <div class="min-w-0 flex-1">
                          <div class="flex items-center gap-2">
                            <span class="text-[11px] font-bold tracking-wide text-blue-700 uppercase">Now</span>
                            {% if item.is_completed %}
                              <i class="fas fa-check-circle text-emerald-600 text-sm"></i>
                            {% endif %}
                          </div>
                          <div class="mt-1 font-semibold text-slate-900 text-sm leading-snug line-clamp-2">
                            {{ item.lesson.title }}
                          </div>
                        </div>
                      </div>
                    </div>

                  {% elif item.is_unlocked %}
                    <a href="{% url 'lesson_detail' course.slug item.lesson.slug %}"
                       class="block rounded-2xl border border-black/5 bg-white px-4 py-3 shadow-sm hover:shadow-md hover:-translate-y-[1px] transition">
                      <div class="flex items-start gap-3">
                        <div class="mt-0.5 flex-shrink-0">
                          {% if item.is_completed %}
                            <div class="h-8 w-8 rounded-2xl bg-emerald-600 flex items-center justify-center shadow-sm">
                              <i class="fas fa-check text-white text-xs"></i>
                            </div>
                          {% else %}
                            <div class="h-8 w-8 rounded-2xl bg-slate-100 flex items-center justify-center border border-black/5">
                              <span class="text-xs font-bold text-slate-600">{{ forloop.counter }}</span>
                            </div>
                          {% endif %}
                        </div>

                        <div class="min-w-0 flex-1">
                          {% if item.is_completed %}
                            <div class="text-[11px] font-bold tracking-wide text-emerald-700 uppercase">Completed</div>
                          {% endif %}
                          <div class="mt-1 font-semibold text-slate-900 text-sm leading-snug line-clamp-2">
                            {{ item.lesson.title }}
                          </div>
                        </div>
                      </div>
                    </a>

                  {% else %}
                    <div class="rounded-2xl border border-black/5 bg-slate-50/80 px-4 py-3 opacity-80">
                      <div class="flex items-start gap-3">
                        <div class="mt-0.5 flex-shrink-0">
                          <div class="h-8 w-8 rounded-2xl bg-slate-200 flex items-center justify-center border border-black/5">
                            <span class="text-xs font-bold text-slate-500">{{ forloop.counter }}</span>
                          </div>
                        </div>

                        <div class="min-w-0 flex-1">
                          <div class="flex items-center gap-2">
                            <i class="fas fa-lock text-slate-400 text-xs"></i>
                            <span class="text-[11px] font-bold tracking-wide text-slate-500 uppercase">Locked</span>
                          </div>
                          <div class="mt-1 font-semibold text-slate-700 text-sm leading-snug line-clamp-2">
                            {{ item.lesson.title }}
                          </div>
                          <div class="mt-1 text-xs text-slate-500">Complete the previous lesson to unlock</div>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>

            <!-- Progress panel (kept in left rail) -->
            <div class="rounded-[28px] border border-black/5 bg-white/70 backdrop-blur-xl shadow-[0_12px_40px_rgba(2,6,23,0.08)] p-6">
              <h3 class="text-lg font-semibold text-slate-900">Progress</h3>
              <p class="mt-1 text-sm text-slate-600">Keep momentum. Consistency wins.</p>

              {% if progress %}
                <div class="mt-5">
                  <div class="flex justify-between text-xs font-semibold text-slate-500 mb-2">
                    <span>Video watched</span>
                    <span class="text-slate-900">{{ progress.video_watch_percentage|floatformat:1 }}%</span>
                  </div>
                  <div class="h-2.5 rounded-full bg-slate-100 overflow-hidden border border-black/5">
                    <div class="h-2.5 rounded-full bg-[linear-gradient(90deg,rgba(124,58,237,1),rgba(6,182,212,1))]"
                         style="width: {{ progress.video_watch_percentage }}%"></div>
                  </div>
                </div>

                <div class="mt-5">
                  {% if not progress.completed %}
                    <button onclick="completeLesson({{ lesson.id }})"
                            class="inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-emerald-600 px-5 py-3 text-sm font-semibold text-white shadow-sm hover:bg-emerald-700 transition">
                      <i class="fas fa-check"></i>
                      Mark complete
                    </button>
                    <p class="mt-3 text-xs text-slate-500">
                      If a quiz is required, you’ll be redirected automatically.
                    </p>
                  {% else %}
                    <div class="flex items-center gap-3 rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3">
                      <i class="fas fa-check-circle text-emerald-600 text-xl"></i>
                      <div>
                        <div class="text-sm font-semibold text-emerald-700">Completed</div>
                        <div class="text-xs text-emerald-700/80">Nice — keep the streak alive.</div>
                      </div>
                    </div>
                  {% endif %}
                </div>
              {% else %}
                <div class="mt-5 rounded-2xl border border-black/5 bg-white px-4 py-4">
                  <p class="text-sm text-slate-600">Start watching to track progress.</p>
                </div>
              {% endif %}
            </div>

          </div>
        </div>
      </aside>

      <!-- RIGHT: Lesson Content (70%) -->
      <main class="lg:col-span-7 min-w-0">

        <!-- Video hero -->
        <div class="rounded-[28px] border border-black/5 bg-white/70 backdrop-blur-xl shadow-[0_14px_55px_rgba(2,6,23,0.10)] overflow-hidden">
          <div class="relative">
            <div class="aspect-video bg-black">
              {% if lesson.vimeo_id %}
              <iframe src="https://player.vimeo.com/video/{{ lesson.vimeo_id }}?autoplay=0&title=0&byline=0&portrait=0"
                      class="w-full h-full"
                      frameborder="0"
                      allow="autoplay; fullscreen; picture-in-picture"
                      allowfullscreen></iframe>
              {% elif lesson.google_drive_url or lesson.google_drive_id %}
              <iframe src="{% if lesson.get_google_drive_embed_url %}{{ lesson.get_google_drive_embed_url }}{% else %}https://drive.google.com/file/d/{{ lesson.google_drive_id }}/preview{% endif %}"
                      class="w-full h-full"
                      frameborder="0"
                      allow="autoplay; fullscreen; picture-in-picture"
                      allowfullscreen></iframe>
              {% elif lesson.video_url %}
              <video id="video-player" class="w-full h-full" controls>
                <source src="{{ lesson.video_url }}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
              {% else %}
              <div class="w-full h-full flex items-center justify-center text-white">
                <div class="text-center">
                  <i class="fas fa-video text-6xl mb-4 opacity-50"></i>
                  <p class="font-semibold">Video not configured</p>
                  <p class="text-sm text-white/70 mt-1">Add a Vimeo ID, Drive URL, or video_url.</p>
                </div>
              </div>
              {% endif %}
            </div>

            <div class="absolute inset-x-0 bottom-0 h-16 bg-[linear-gradient(to_top,rgba(2,6,23,0.55),transparent)]"></div>

            <div class="absolute top-4 left-4 right-4 flex flex-wrap items-center gap-2">
              <span class="inline-flex items-center gap-2 rounded-full bg-white/15 backdrop-blur px-3 py-1 text-xs font-semibold text-white border border-white/20">
                <i class="fas fa-layer-group text-white/80"></i> Lesson
              </span>
              <span class="inline-flex items-center gap-2 rounded-full bg-white/15 backdrop-blur px-3 py-1 text-xs font-semibold text-white border border-white/20">
                <i class="fas fa-clock text-white/80"></i> {{ lesson.get_formatted_duration }}
              </span>
              {% if progress %}
              <span class="inline-flex items-center gap-2 rounded-full bg-white/15 backdrop-blur px-3 py-1 text-xs font-semibold text-white border border-white/20">
                <i class="fas fa-chart-line text-white/80"></i> {{ progress.progress_percentage }}% complete
              </span>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Lesson header -->
        <div class="mt-6 rounded-[28px] border border-black/5 bg-white/75 backdrop-blur-xl shadow-[0_12px_40px_rgba(2,6,23,0.08)] p-8">
          <div class="space-y-6">
            <div>
              <h1 class="text-3xl md:text-4xl font-semibold tracking-tight text-slate-900">
                {{ lesson.title }}
              </h1>

              {% if lesson.description %}
              <p class="mt-3 text-base md:text-lg text-slate-600 leading-7">
                {{ lesson.description }}
              </p>
              {% endif %}

              <div class="mt-5 flex flex-wrap items-center gap-2">
                <span class="inline-flex items-center gap-2 rounded-full border border-black/5 bg-white px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm">
                  <span class="inline-block h-2 w-2 rounded-full bg-blue-600"></span>
                  {{ course.name }}
                </span>
                {% if quiz %}
                <span class="inline-flex items-center gap-2 rounded-full border border-black/5 bg-white px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm">
                  <i class="fas fa-question-circle text-blue-600"></i>
                  Quiz included
                </span>
                {% endif %}
              </div>
            </div>

            <div class="flex flex-wrap items-center gap-3 pt-4 border-t border-black/5">
              <a href="{% url 'course_detail' course.slug %}"
                 class="inline-flex items-center gap-2 rounded-2xl border border-black/5 bg-white px-4 py-2.5 text-sm font-semibold text-slate-800 shadow-sm hover:bg-slate-50 hover:shadow-md transition">
                <i class="fas fa-list text-slate-500"></i>
                View all lessons
              </a>

              {% if next_lesson %}
              <a href="{% url 'lesson_detail' course.slug next_lesson.slug %}"
                 class="inline-flex items-center gap-2 rounded-2xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 transition">
                Continue to next
                <i class="fas fa-arrow-right text-white/80"></i>
              </a>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Lesson Notes -->
        {% if lesson.has_content %}
        <div class="mt-6 rounded-[28px] border border-black/5 bg-white/75 backdrop-blur-xl shadow-[0_12px_40px_rgba(2,6,23,0.08)] p-8">
          <div class="flex items-center justify-between gap-4 mb-6">
            <h2 class="text-xl md:text-2xl font-semibold text-slate-900">Lesson Notes</h2>
            <span class="text-xs font-semibold text-slate-500">Key takeaways & references</span>
          </div>

          <div class="prose prose-lg max-w-none text-slate-700 leading-relaxed
                      prose-headings:text-slate-900 prose-strong:text-slate-900
                      prose-a:text-blue-700 hover:prose-a:text-blue-800">
            {{ lesson.content|render_editorjs }}
          </div>
        </div>
        {% endif %}

        <!-- Quiz -->
        {% if quiz %}
        <div class="mt-6 rounded-[28px] border border-black/5 bg-white/75 backdrop-blur-xl shadow-[0_12px_40px_rgba(2,6,23,0.08)] p-8">
          <div class="flex items-start justify-between gap-6 flex-col md:flex-row">
            <div>
              <h2 class="text-xl md:text-2xl font-semibold text-slate-900 flex items-center gap-2">
                <span class="inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-blue-600 text-white shadow-sm">
                  <i class="fas fa-question"></i>
                </span>
                Lesson Quiz
              </h2>

              {% if quiz_attempt %}
                <p class="mt-3 text-slate-600">
                  Your score:
                  <span class="font-semibold {% if quiz_attempt.passed %}text-emerald-600{% else %}text-rose-600{% endif %}">
                    {{ quiz_attempt.score|floatformat:1 }}%
                  </span>
                </p>

                {% if quiz_attempt.passed %}
                  <p class="mt-2 text-emerald-600 font-semibold"><i class="fas fa-check-circle mr-2"></i>Passed</p>
                {% else %}
                  <p class="mt-2 text-rose-600 font-semibold">
                    <i class="fas fa-times-circle mr-2"></i>Not passed (required {{ quiz.passing_score }}%)
                  </p>
                {% endif %}
              {% else %}
                <p class="mt-3 text-slate-600">Prove mastery and unlock completion.</p>
              {% endif %}
            </div>

            <a href="{% url 'lesson_quiz' course.slug lesson.slug %}"
               class="inline-flex items-center justify-center gap-2 rounded-2xl bg-slate-900 px-6 py-3 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 transition w-full md:w-auto">
              {% if quiz_attempt %}Retake Quiz{% else %}Take Quiz{% endif %}
              <i class="fas fa-arrow-right text-white/80"></i>
            </a>
          </div>
        </div>
        {% endif %}

      </main>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script>
const videoPlayer = document.getElementById('video-player');
const vimeoFrame = document.querySelector('iframe[src*="vimeo"]');

let lastSentAt = 0;

function getCsrfToken() {
  const name = 'csrftoken';
  const cookies = document.cookie.split(';');
  for (let c of cookies) {
    c = c.trim();
    if (c.startsWith(name + '=')) return decodeURIComponent(c.substring(name.length + 1));
  }
  return '';
}

function updateProgressThrottled() {
  const now = Date.now();
  if (now - lastSentAt < 5000) return;
  lastSentAt = now;

  const lessonId = {{ lesson.id }};
  let currentTime = 0;
  let duration = 0;
  let watchPercentage = 0;

  if (videoPlayer && videoPlayer.readyState >= 2) {
    currentTime = videoPlayer.currentTime || 0;
    duration = videoPlayer.duration || 0;
    if (duration > 0) watchPercentage = (currentTime / duration) * 100;
  }

  if (watchPercentage > 0) {
    fetch(`/api/lessons/${lessonId}/progress/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCsrfToken(),
      },
      body: JSON.stringify({
        watch_percentage: watchPercentage,
        timestamp: currentTime
      })
    }).catch(err => console.error('Progress update error:', err));
  }
}

if (videoPlayer) {
  videoPlayer.addEventListener('timeupdate', updateProgressThrottled);
} else if (vimeoFrame) {
  // Vimeo tracking requires Vimeo Player API (intentional no-op)
}

async function completeLesson(lessonId) {
  try {
    if (typeof showPreloader === 'function') showPreloader('Marking lesson as complete...');
    const response = await fetch(`/api/lessons/${lessonId}/complete/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCsrfToken() },
    });

    const data = await response.json();
    if (typeof hidePreloader === 'function') hidePreloader();

    if (data.success) {
      // Trigger confetti effect
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 },
        colors: ['#7c3aed', '#06b6d4', '#10b981', '#f59e0b', '#ef4444']
      });
      
      // Additional burst after a short delay
      setTimeout(() => {
        confetti({
          particleCount: 50,
          angle: 60,
          spread: 55,
          origin: { x: 0 },
          colors: ['#7c3aed', '#06b6d4', '#10b981']
        });
        confetti({
          particleCount: 50,
          angle: 120,
          spread: 55,
          origin: { x: 1 },
          colors: ['#7c3aed', '#06b6d4', '#10b981']
        });
      }, 250);

      // Show preloader and redirect to next lesson after confetti
      {% if next_lesson %}
      setTimeout(() => {
        if (typeof showPreloader === 'function') {
          showPreloader('Loading your next lesson...');
        }
        setTimeout(() => {
          window.location.href = '{% url "lesson_detail" course.slug next_lesson.slug %}';
        }, 500); // Small delay to show preloader
      }, 2000); // 2 second delay to enjoy the confetti
      {% else %}
      // No next lesson, just reload to show completion status
      setTimeout(() => {
        location.reload();
      }, 2000);
      {% endif %}
    } else {
      alert(data.error || 'Failed to complete lesson');
      if (data.quiz_required) {
        window.location.href = '{% url "lesson_quiz" course.slug lesson.slug %}';
      }
    }
  } catch (error) {
    if (typeof hidePreloader === 'function') hidePreloader();
    console.error('Error completing lesson:', error);
    alert('An error occurred. Please try again.');
  }
}
</script>
{% endblock %}
