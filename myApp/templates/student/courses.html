{% extends 'base.html' %}

{% block title %}Courses - Learning Platform{% endblock %}

{% block content %}
<div class="min-h-screen relative">

  <div class="max-w-7xl mx-auto px-6 py-12">

    <!-- Header -->
    <header class="mb-10">
      <div class="rounded-[32px] border border-black/5 bg-white/70 backdrop-blur-xl shadow-[0_18px_70px_rgba(2,6,23,0.10)] overflow-hidden">
        <div class="p-10">
          <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-8">
            <div>
              <div class="inline-flex items-center gap-2 rounded-full border border-black/5 bg-white px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm">
                <span class="inline-block h-2 w-2 rounded-full bg-emerald-500"></span>
                Course Hub
              </div>

              <h1 class="mt-4 text-5xl font-semibold tracking-tight text-slate-900">
                Course Library
              </h1>

              <p class="mt-3 max-w-2xl text-base leading-7 text-slate-600">
                Curated programs designed to compound skills, confidence, and career leverage.
              </p>

              <!-- Mini highlights -->
              <div class="mt-6 flex flex-wrap gap-2">
                <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 text-xs font-semibold text-slate-700 border border-black/5 shadow-sm">
                  <i class="fas fa-bolt text-violet-600"></i> Fast to finish
                </span>
                <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 text-xs font-semibold text-slate-700 border border-black/5 shadow-sm">
                  <i class="fas fa-layer-group text-cyan-600"></i> Structured learning
                </span>
                <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 text-xs font-semibold text-slate-700 border border-black/5 shadow-sm">
                  <i class="fas fa-chart-line text-emerald-600"></i> Measurable progress
                </span>
              </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 gap-3 w-full lg:w-auto">
              <div class="rounded-2xl border border-black/5 bg-white px-5 py-4 shadow-sm">
                <div class="text-xs font-semibold text-slate-500">Focus</div>
                <div class="mt-1 text-sm font-semibold text-slate-900">Skill compounding</div>
              </div>
              <div class="rounded-2xl border border-black/5 bg-white px-5 py-4 shadow-sm">
                <div class="text-xs font-semibold text-slate-500">Delivery</div>
                <div class="mt-1 text-sm font-semibold text-slate-900">Practical lessons</div>
              </div>
            </div>
          </div>
        </div>

        <div class="h-1 w-full bg-[linear-gradient(90deg,rgba(124,58,237,0.95),rgba(6,182,212,0.95))]"></div>
      </div>
    </header>

    <!-- Controls -->
    <section class="mb-10">
      <div class="rounded-[26px] border border-black/5 bg-white/75 backdrop-blur-xl shadow-[0_12px_40px_rgba(2,6,23,0.08)] p-5">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">

          <!-- Search (now functional client-side) -->
          <div class="relative w-full lg:max-w-md">
            <div class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
              <i class="fas fa-search"></i>
            </div>
            <input
              id="courseSearch"
              type="text"
              placeholder="Search courses..."
              class="w-full rounded-2xl border border-black/5 bg-white px-10 py-3 text-sm text-slate-800 shadow-sm outline-none ring-0
                     focus:border-violet-200 focus:ring-4 focus:ring-violet-100"
            />
          </div>

          <div class="flex flex-wrap items-center gap-3">
            {% if user.is_authenticated %}
              <label class="group inline-flex items-center gap-3 rounded-2xl border border-black/5 bg-white px-4 py-3 shadow-sm hover:shadow-md transition cursor-pointer">
                <input type="checkbox"
                       {% if filter_favorites %}checked{% endif %}
                       onchange="window.location.href='?favorites=' + (this.checked ? 'true' : '')"
                       class="h-4 w-4 rounded border-black/10 text-rose-500 focus:ring-4 focus:ring-rose-100">
                <span class="text-sm font-semibold text-slate-800 group-hover:text-rose-600 transition">
                  <i class="fas fa-heart mr-1"></i> Favorites
                </span>
              </label>
            {% endif %}

            <div class="inline-flex items-center gap-2 rounded-2xl border border-black/5 bg-white px-4 py-3 shadow-sm">
              <span class="text-xs font-semibold text-slate-500">Sort</span>
              <select id="courseSort" class="bg-transparent text-sm font-semibold text-slate-800 outline-none">
                <option value="recommended">Recommended</option>
                <option value="az">A → Z</option>
                <option value="za">Z → A</option>
                <option value="progress">Progress (high → low)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Results meta -->
        <div class="mt-4 flex items-center justify-between text-xs text-slate-500">
          <span id="resultsCount">Showing courses</span>
          <button id="clearSearch" class="font-semibold hover:text-slate-900 transition hidden">Clear</button>
        </div>
      </div>
    </section>

    <!-- CONTINUE LEARNING -->
    {% if continue_learning %}
    <section class="mb-14">
      <div class="flex items-end justify-between mb-6">
        <div>
          <h2 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-violet-600 text-white shadow-sm">
              <i class="fas fa-play"></i>
            </span>
            Continue
          </h2>
          <p class="mt-1 text-sm text-slate-600">Pick up exactly where you left off.</p>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-6" data-course-grid>
        {% for course in continue_learning %}
        <article
          class="course-card group rounded-[28px] border border-black/5 bg-white/80 backdrop-blur shadow-[0_12px_40px_rgba(2,6,23,0.08)] overflow-hidden transition
                 hover:-translate-y-1 hover:shadow-[0_18px_70px_rgba(2,6,23,0.12)]"
          data-title="{{ course.name|lower }}"
          data-progress="{{ course.user_progress_percent|default:0 }}"
          data-section="continue"
        >
          <div class="relative">
            {% if course.thumbnail %}
              <img src="{{ course.thumbnail.url }}" class="h-52 w-full object-cover">
            {% else %}
              <div class="h-52 bg-[linear-gradient(135deg,rgba(124,58,237,1),rgba(6,182,212,1))] flex items-center justify-center">
                <i class="fas fa-book text-6xl text-white/30"></i>
              </div>
            {% endif %}
            <div class="absolute inset-0 bg-[linear-gradient(to_top,rgba(2,6,23,0.62),transparent_60%)]"></div>

            <div class="absolute top-4 left-4">
              <span class="inline-flex items-center gap-2 rounded-full bg-white/15 backdrop-blur px-3 py-1 text-xs font-semibold text-white border border-white/20">
                <i class="fas fa-circle text-emerald-400 text-[10px]"></i> Active
              </span>
            </div>

            <div class="absolute bottom-4 left-4 right-4">
              <h3 class="text-white font-semibold text-lg leading-tight drop-shadow line-clamp-2">
                {{ course.name }}
              </h3>
            </div>
          </div>

          <div class="p-6">
            <p class="text-sm text-slate-600 leading-6 mb-4 line-clamp-2">
              {{ course.short_description|default:course.description|truncatewords:18 }}
            </p>

            {% with progress=course.user_progress_percent|default:0 %}
            <div class="mb-5">
              <div class="flex justify-between text-xs font-semibold text-slate-500 mb-2">
                <span>Progress</span>
                <span class="text-slate-900">{{ progress }}%</span>
              </div>
              <div class="h-2.5 rounded-full bg-slate-100 overflow-hidden border border-black/5">
                <div class="h-2.5 rounded-full bg-[linear-gradient(90deg,rgba(124,58,237,1),rgba(6,182,212,1))]"
                     style="width: {{ progress|floatformat:0 }}%"></div>
              </div>
            </div>
            {% endwith %}

            <a href="{% url 'course_detail' course.slug %}"
               class="inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-slate-900 px-5 py-3 text-white text-sm font-semibold shadow-sm hover:bg-slate-800 transition">
              Continue
              <i class="fas fa-arrow-right text-white/80"></i>
            </a>
          </div>
        </article>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- MY COURSES -->
    {% if my_courses %}
    <section class="mb-14">
      <div class="flex items-end justify-between mb-6">
        <div>
          <h2 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-cyan-600 text-white shadow-sm">
              <i class="fas fa-graduation-cap"></i>
            </span>
            My Courses
          </h2>
          <p class="mt-1 text-sm text-slate-600">Your active and completed programs.</p>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-6" data-course-grid>
        {% for course in my_courses %}
        <article
          class="course-card group rounded-[28px] border border-black/5 bg-white/80 backdrop-blur shadow-[0_12px_40px_rgba(2,6,23,0.08)] overflow-hidden transition
                 hover:-translate-y-1 hover:shadow-[0_18px_70px_rgba(2,6,23,0.12)]"
          data-title="{{ course.name|lower }}"
          data-progress="{{ course.user_progress_percent|default:0 }}"
          data-section="mine"
        >
          <div class="relative">
            {% if course.thumbnail %}
              <img src="{{ course.thumbnail.url }}" class="h-52 w-full object-cover">
            {% else %}
              <div class="h-52 bg-[linear-gradient(135deg,rgba(124,58,237,1),rgba(6,182,212,1))] flex items-center justify-center">
                <i class="fas fa-book text-6xl text-white/30"></i>
              </div>
            {% endif %}

            <div class="absolute inset-0 bg-[linear-gradient(to_top,rgba(2,6,23,0.62),transparent_62%)]"></div>

            <div class="absolute top-4 right-4">
              <button onclick="toggleFavorite({{ course.id }})"
                      class="inline-flex h-11 w-11 items-center justify-center rounded-2xl border border-white/20 bg-black/30 backdrop-blur shadow-sm hover:bg-black/40 transition">
                <i class="fas fa-heart text-lg {% if course.is_favorited or course.id in favorited_ids %}text-rose-400{% else %}text-white/70 hover:text-rose-300{% endif %}"></i>
              </button>
            </div>

            <div class="absolute top-4 left-4">
              {% if course.is_completed %}
                <span class="inline-flex items-center gap-2 rounded-full bg-emerald-500/95 px-3 py-1 text-xs font-semibold text-white shadow-sm">
                  <span class="h-1.5 w-1.5 rounded-full bg-white"></span> Completed
                </span>
              {% elif course.user_progress_percent > 0 %}
                <span class="inline-flex items-center gap-2 rounded-full bg-cyan-600/95 px-3 py-1 text-xs font-semibold text-white shadow-sm">
                  <span class="h-1.5 w-1.5 rounded-full bg-white"></span> In progress
                </span>
              {% else %}
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-900/90 px-3 py-1 text-xs font-semibold text-white shadow-sm">
                  <span class="h-1.5 w-1.5 rounded-full bg-white"></span> Not started
                </span>
              {% endif %}
            </div>

            <div class="absolute bottom-4 left-4 right-4">
              <h3 class="text-white font-semibold text-lg leading-tight drop-shadow line-clamp-2">
                {{ course.name }}
              </h3>
            </div>
          </div>

          <div class="p-6">
            <p class="text-sm text-slate-600 leading-6 mb-4 line-clamp-2">
              {{ course.short_description|default:course.description|truncatewords:18 }}
            </p>

            {% with progress=course.user_progress_percent|default:0 %}
            <div class="mb-5">
              <div class="flex justify-between text-xs font-semibold text-slate-500 mb-2">
                <span>Progress</span>
                <span class="text-slate-900">{{ progress }}%</span>
              </div>
              <div class="h-2.5 rounded-full bg-slate-100 overflow-hidden border border-black/5">
                <div class="h-2.5 rounded-full
                            {% if course.is_completed %}
                              bg-[linear-gradient(90deg,rgba(16,185,129,1),rgba(34,197,94,1))]
                            {% else %}
                              bg-[linear-gradient(90deg,rgba(6,182,212,1),rgba(124,58,237,1))]
                            {% endif %}"
                     style="width: {{ progress|floatformat:0 }}%"></div>
              </div>
            </div>
            {% endwith %}

            <a href="{% url 'course_detail' course.slug %}"
               class="inline-flex w-full items-center justify-center gap-2 rounded-2xl px-5 py-3 text-sm font-semibold shadow-sm transition
               {% if course.is_completed %}
                 bg-emerald-600 text-white hover:bg-emerald-700
               {% elif course.user_progress_percent > 0 %}
                 bg-cyan-600 text-white hover:bg-cyan-700
               {% else %}
                 bg-slate-900 text-white hover:bg-slate-800
               {% endif %}">
              {% if course.is_completed %}View Course{% elif course.user_progress_percent > 0 %}Continue{% else %}Start Course{% endif %}
              <i class="fas fa-arrow-right text-white/80"></i>
            </a>
          </div>
        </article>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- AVAILABLE COURSES -->
    {% if available_courses %}
    <section class="mb-8">
      <div class="flex items-end justify-between mb-6">
        <div>
          <h2 class="text-2xl font-semibold text-slate-900 flex items-center gap-2">
            <span class="inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-violet-600 text-white shadow-sm">
              <i class="fas fa-compass"></i>
            </span>
            Explore
          </h2>
          <p class="mt-1 text-sm text-slate-600">Discover new programs worth your attention.</p>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-6" data-course-grid>
        {% for course in available_courses %}
        <article
          class="course-card group rounded-[28px] border border-black/5 bg-white/80 backdrop-blur shadow-[0_12px_40px_rgba(2,6,23,0.08)] overflow-hidden transition
                 hover:-translate-y-1 hover:shadow-[0_18px_70px_rgba(2,6,23,0.12)]"
          data-title="{{ course.name|lower }}"
          data-progress="0"
          data-section="explore"
        >
          <div class="relative">
            {% if course.thumbnail %}
              <img src="{{ course.thumbnail.url }}" class="h-52 w-full object-cover">
            {% else %}
              <div class="h-52 bg-[linear-gradient(135deg,rgba(124,58,237,1),rgba(6,182,212,1))] flex items-center justify-center">
                <i class="fas fa-book text-6xl text-white/30"></i>
              </div>
            {% endif %}
            <div class="absolute inset-0 bg-[linear-gradient(to_top,rgba(2,6,23,0.52),transparent_62%)]"></div>
            <div class="absolute bottom-4 left-4 right-4">
              <h3 class="text-white font-semibold text-lg leading-tight drop-shadow line-clamp-2">
                {{ course.name }}
              </h3>
            </div>
          </div>

          <div class="p-6">
            <p class="text-sm text-slate-600 leading-6 mb-5 line-clamp-2">
              {{ course.short_description|default:course.description|truncatewords:18 }}
            </p>

            <a href="{% url 'course_detail' course.slug %}"
               class="inline-flex w-full items-center justify-center gap-2 rounded-2xl border border-black/5 bg-white px-5 py-3 text-sm font-semibold text-slate-900 shadow-sm
                      hover:bg-slate-50 hover:shadow-md transition">
              Learn More
              <i class="fas fa-arrow-right text-slate-500"></i>
            </a>
          </div>
        </article>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- EMPTY STATE -->
    {% if not my_courses and not available_courses and not continue_learning %}
    <div class="rounded-[28px] border border-black/5 bg-white/75 backdrop-blur-xl shadow-[0_10px_30px_rgba(2,6,23,0.06)] p-12 text-center">
      <div class="mx-auto mb-4 inline-flex h-14 w-14 items-center justify-center rounded-3xl bg-slate-900 text-white shadow-sm">
        <i class="fas fa-layer-group"></i>
      </div>
      <p class="text-xl font-semibold text-slate-900">No courses available yet.</p>
      <p class="mt-2 text-sm text-slate-600">New opportunities are being prepared.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCsrfToken() {
  const name = 'csrftoken';
  const cookies = document.cookie.split(';');
  for (let c of cookies) {
    c = c.trim();
    if (c.startsWith(name + '=')) return decodeURIComponent(c.substring(name.length + 1));
  }
  return '';
}

async function toggleFavorite(courseId) {
  try {
    const response = await fetch(`/api/courses/${courseId}/favorite/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCsrfToken() },
    });
    const data = await response.json();
    if (data.success) location.reload();
  } catch (e) {
    console.error(e);
  }
}

/* Client-side search + sort across all visible cards (no backend needed) */
(function () {
  const searchInput = document.getElementById('courseSearch');
  const sortSelect = document.getElementById('courseSort');
  const clearBtn = document.getElementById('clearSearch');
  const resultsCount = document.getElementById('resultsCount');

  function getCards() {
    return Array.from(document.querySelectorAll('.course-card'));
  }

  function applyFilterAndSort() {
    const q = (searchInput?.value || '').trim().toLowerCase();
    const sort = sortSelect?.value || 'recommended';

    if (clearBtn) clearBtn.classList.toggle('hidden', q.length === 0);

    // Filter
    const cards = getCards();
    let visible = 0;

    cards.forEach(card => {
      const title = card.getAttribute('data-title') || '';
      const match = q === '' || title.includes(q);
      card.classList.toggle('hidden', !match);
      if (match) visible += 1;
    });

    // Sort within each grid container
    const grids = Array.from(document.querySelectorAll('[data-course-grid]'));
    grids.forEach(grid => {
      const gridCards = Array.from(grid.querySelectorAll('.course-card')).filter(c => !c.classList.contains('hidden'));

      const sorted = gridCards.sort((a, b) => {
        const at = (a.getAttribute('data-title') || '');
        const bt = (b.getAttribute('data-title') || '');
        const ap = parseFloat(a.getAttribute('data-progress') || '0');
        const bp = parseFloat(b.getAttribute('data-progress') || '0');

        if (sort === 'az') return at.localeCompare(bt);
        if (sort === 'za') return bt.localeCompare(at);
        if (sort === 'progress') return bp - ap;
        return 0; // recommended (keep server order)
      });

      sorted.forEach(node => grid.appendChild(node));
    });

    if (resultsCount) resultsCount.textContent = `Showing ${visible} course${visible === 1 ? '' : 's'}`;
  }

  if (searchInput) searchInput.addEventListener('input', applyFilterAndSort);
  if (sortSelect) sortSelect.addEventListener('change', applyFilterAndSort);
  if (clearBtn) clearBtn.addEventListener('click', () => { searchInput.value = ''; applyFilterAndSort(); });

  applyFilterAndSort();
})();
</script>
{% endblock %}
